name: Deploy Monitoring Only

on:
  push:
    branches: [ "main" ]
    paths:
      - 'monitoring/**'
      - 'docker-compose.monitoring.yaml'
  workflow_dispatch:

env:
  HOST: ${{ secrets.VM_HOST_MONITORING }}
  USERNAME: ${{ secrets.VM_USERNAME_MONITORING }}
  KEY: ${{ secrets.VM_KEY_MONITORING }}
  TARGET_DIR: "~/whoknows_deployment"

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          echo "${{ env.KEY }}" > key.pem
          chmod 600 key.pem

      - name: Copy files via SCP
        run: |
          # A. Opret mappen
          ssh -i key.pem -o StrictHostKeyChecking=no $USERNAME@$HOST "mkdir -p $TARGET_DIR"

          # B. Kopier docker-compose filen
          scp -i key.pem -o StrictHostKeyChecking=no monitoring/docker-compose.monitoring.yaml $USERNAME@$HOST:$TARGET_DIR/

          # C. Kopier monitoring mappen
          scp -i key.pem -o StrictHostKeyChecking=no -r monitoring $USERNAME@$HOST:$TARGET_DIR/
          
          echo "âœ… Filer kopieret succesfuldt."


      - name: Restart Grafana and Prometheus
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no $USERNAME@$HOST " \
            cd $TARGET_DIR && \
            sudo docker-compose -f docker-compose.monitoring.yaml pull && \
            sudo docker-compose -f docker-compose.monitoring.yaml down && \
            sudo docker rm -f prometheus-dashboard || true && \
            sudo docker rm -f grafana || true && \
            sudo docker-compose -f docker-compose.monitoring.yaml up -d --remove-orphans \
          "
        shell: bash

      - name: Cleanup Key
        if: always()
        run: rm -f key.pem